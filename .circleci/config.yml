version: 2
jobs:
   build:
     working_directory: ~/leviathan
     docker:
       image: hhyyrylainen/leviathan-deps:v6
       environment:
         GIT_LFS_SKIP_SMUDGE: 1
     steps:
       - checkout
       - restore_cache:
           keys:
             - v1-lfs-{{ .Branch }}
             - v1-lfs-master
       - shell:
           name: Pull Git LFS files, retry until done
           command: |
             while true; do git reset --hard HEAD && git clean -fd && git lfs pull && break; done
       - save_cache:
          key: v1-lfs-{{ .Branch }}
          paths:
            - .git/lfs
       - restore_cache:
           keys:
             - v6-deps-{{ arch }}-{{ checksum "Setup.rb" }}-{{ checksum "LeviathanLibraries.rb" }}
             - v6-deps-{{ arch }}
       - restore_cache:
           keys:
             - v5-build-{{ arch }}-{{ .Branch }}
       - run: ./Setup.rb --no-packagemanager --no-updates -j 2 --fully-parallel-project-compile --project-parallel 5
       - save_cache:
           key: v6-deps-{{ arch }}-{{ checksum "Setup.rb" }}-{{ checksum "LeviathanLibraries.rb" }}
           paths:
             - ThirdParty
       - save_cache:
           key: v6-deps-{{ arch }}
           paths:
             - ThirdParty
       - save_cache:
           key: v5-build-{{ arch }}-{{ .Branch }}
           paths:
             - build/Engine
             - build/LeviathanTest
             - build/Pong
             - build/PongMasterServer
             - build/PongServer
             - build/CMakeFiles
             - build/CMakeCache.txt
             - build/Makefile
       - run: mkdir -p /reports/reports
       - run:
           command: ./LeviathanTest "~[xrequired]"
           working_directory: ~/leviathan/build/bin
       # - run:
       #     command: ./LeviathanTest --reporter junit --out /reports/reports/test_run.xml "~[xrequired]"
       #     working_directory: ~/leviathan/build/bin
       # - store_test_results:
       #     path: /reports/reports
